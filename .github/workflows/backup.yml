name: Automated Daily Backup

on:
  schedule:
    # Run backup every day at 2 AM UTC (7:30 AM IST)
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create backup directory
        run: |
          mkdir -p backups
          echo "Backup created at $(date)" > backups/BACKUP_INFO.txt
          echo "Branch: main" >> backups/BACKUP_INFO.txt
          echo "Commit: ${{ github.sha }}" >> backups/BACKUP_INFO.txt

      - name: Create git bundle
        run: |
          git bundle create backups/repo-$(date +%Y%m%d-%H%M%S).bundle --all
          ls -lh backups/

      - name: Commit backup to git-backups branch
        run: |
          set -x  # Enable debug output
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # Save the backup files before switching branches
          cp -r backups /tmp/backups_temp

          # Try to fetch existing git-backups branch, create new orphan if it doesn't exist
          if git ls-remote --heads origin git-backups | grep -q git-backups; then
            echo "Fetching existing git-backups branch..."
            git fetch origin git-backups
            git checkout -B git-backups origin/git-backups
          else
            echo "Creating new orphan git-backups branch..."
            git checkout --orphan git-backups
            git rm -rf . 2>/dev/null || true
          fi

          # Restore backup files
          cp -r /tmp/backups_temp/* . 2>/dev/null || true

          # Move bundle files to root for easier access
          mv *.bundle . 2>/dev/null || true
          mv *.txt . 2>/dev/null || true
          rm -rf backups 2>/dev/null || true

          git add -A
          git status
          git commit -m "Automated backup - $(date +%Y-%m-%d\ %H:%M:%S)" || echo "No changes to commit"
          git push origin git-backups --force

      - name: Keep only last 30 backups
        run: |
          # Keep only the 30 most recent bundle files
          ls -t *.bundle 2>/dev/null | tail -n +31 | xargs rm -f 2>/dev/null || true
          git add -A
          git commit -m "Cleanup old backups - $(date)" || echo "No old backups to remove"
          git push origin git-backups --force || true

      - name: Generate backup summary
        run: |
          echo "# Backup Summary" > BACKUP_SUMMARY.md
          echo "Date: $(date)" >> BACKUP_SUMMARY.md
          echo "Backup Status: ✅ SUCCESS" >> BACKUP_SUMMARY.md
          echo "" >> BACKUP_SUMMARY.md
          echo "## Latest Backup" >> BACKUP_SUMMARY.md
          echo "- Commit: ${{ github.sha }}" >> BACKUP_SUMMARY.md
          echo "- Branch: main" >> BACKUP_SUMMARY.md
          echo "- Files: $(git ls-files | wc -l)" >> BACKUP_SUMMARY.md
          echo "- Database: See backups branch" >> BACKUP_SUMMARY.md
          cat BACKUP_SUMMARY.md

  database-backup:
    runs-on: ubuntu-latest
    needs: backup

    steps:
      - name: Database backup info
        run: |
          echo "Database Backup Information"
          echo "=============================="
          echo "Database backups are handled separately on the hosting server."
          echo "Schedule: Daily at 10 PM IST via crontab"
          echo "Location: /home/bombayengg/backups/"
          echo "Retention: 30 days"
          echo ""
          echo "Last check: $(date)"

  notify:
    runs-on: ubuntu-latest
    if: always()
    needs: [backup, database-backup]

    steps:
      - name: Backup completion notification
        run: |
          echo "✅ Automated backup completed successfully!"
          echo ""
          echo "Backup Details:"
          echo "- Time: $(date)"
          echo "- Status: Complete"
          echo "- Location: GitHub backups branch"
          echo "- Frequency: Daily"
          echo ""
          echo "To restore from backup:"
          echo "1. Go to: https://github.com/pari588/bessite"
          echo "2. Switch to: git-backups branch"
          echo "3. Download: repo-YYYYMMDD-HHMMSS.bundle"
          echo "4. Run: git clone repo-*.bundle"
