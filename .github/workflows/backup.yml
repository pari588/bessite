name: Automated Daily Backup

on:
  schedule:
    # Run backup every day at 2 AM UTC (7:30 AM IST)
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create backup tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # Create a dated tag for this backup
          TAG_NAME="backup-$(date +%Y%m%d)"

          # Check if tag exists remotely and delete it (for same-day re-runs)
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG_NAME"; then
            echo "Tag $TAG_NAME exists, deleting..."
            git push origin --delete "$TAG_NAME"
            git tag -d "$TAG_NAME" 2>/dev/null || true
          fi

          # Create new tag
          git tag -a "$TAG_NAME" -m "Automated backup - $(date +%Y-%m-%d %H:%M:%S)"
          git push origin "$TAG_NAME"

          echo "✅ Created backup tag: $TAG_NAME"

      - name: Generate backup summary
        run: |
          echo "# Backup Summary"
          echo "Date: $(date)"
          echo "Backup Status: ✅ SUCCESS"
          echo ""
          echo "## Backup Details"
          echo "- Commit: ${{ github.sha }}"
          echo "- Branch: main"
          echo "- Tag: backup-$(date +%Y%m%d)"
          echo "- Files: $(git ls-files | wc -l)"
          echo ""
          echo "## How to Restore"
          echo "git clone https://github.com/pari588/bessite.git"
          echo "git checkout backup-YYYYMMDD"

  database-backup:
    runs-on: ubuntu-latest
    needs: backup

    steps:
      - name: Database backup info
        run: |
          echo "Database Backup Information"
          echo "=============================="
          echo "Database backups are handled separately on the hosting server."
          echo "Schedule: Daily at 10 PM IST via crontab"
          echo "Location: /home/bombayengg/backups/"
          echo "Retention: 30 days"
          echo ""
          echo "Last check: $(date)"

  notify:
    runs-on: ubuntu-latest
    if: always()
    needs: [backup, database-backup]

    steps:
      - name: Backup completion notification
        run: |
          echo "✅ Automated backup completed successfully!"
          echo ""
          echo "Backup Details:"
          echo "- Time: $(date)"
          echo "- Status: Complete"
          echo "- Location: GitHub backups branch"
          echo "- Frequency: Daily"
          echo ""
          echo "To restore from backup:"
          echo "1. Go to: https://github.com/pari588/bessite"
          echo "2. Switch to: git-backups branch"
          echo "3. Download: repo-YYYYMMDD-HHMMSS.bundle"
          echo "4. Run: git clone repo-*.bundle"
