# Stable configuration with minimal enhancements
<IfModule mod_rewrite.c>
    Options -Indexes
    RewriteEngine On
   
    # Preserve HTTP Authorization header (needed for token authentication)
    SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1

    # Force www and HTTPS
    RewriteCond %{HTTP_HOST} !^www\. [NC]
    RewriteRule ^(.*)$ https://www.bombayengg.net/$1 [L,R=301]

    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

    # Redirect /xadmin to login
    RewriteCond %{HTTP_HOST} ^bombayengg\.net$ [NC]
    RewriteCond %{REQUEST_URI} ^/xadmin/?$ [NC]
    RewriteRule ^xadmin/?$ https://www.bombayengg.net/xadmin/login/ [L,R=301]

    # --- Hard bypass for /tds (do not change the skip block above) ---
    RewriteCond %{REQUEST_URI} ^/tds/ [NC]
    RewriteRule ^ - [L]
    # --- end bypass ---

    # Skip rewrites for static paths and files (NOT in xsite)
    RewriteCond %{REQUEST_URI} ^/test/ [OR]
    RewriteCond %{REQUEST_URI} ^/uploads/ [OR]
    RewriteCond %{REQUEST_URI} ^/core/ [OR]
    RewriteCond %{REQUEST_URI} ^/lib/ [OR]
    RewriteCond %{REQUEST_URI} ^/phpmyadmin/ [OR]
    RewriteCond %{REQUEST_URI} ^/config\.js\.php$ [OR]
    RewriteCond %{REQUEST_URI} ^/robots\.txt$ [OR]
    RewriteCond %{REQUEST_URI} ^/claude\.php$ [OR]
    RewriteCond %{REQUEST_URI} ^/check_handler_logs_now\.php$ [OR]
    RewriteCond %{REQUEST_URI} ^/test_handler_endpoint\.php$ [OR]
    RewriteCond %{REQUEST_URI} ^/diagnose_ocr_handler\.php$ [OR]
    RewriteCond %{REQUEST_URI} ^/ocr-debug\.php$ [OR]
    RewriteCond %{REQUEST_URI} ^/get_ocr_logs\.php$
    RewriteRule ^ - [L]

    # Direct serve sitemap files from xsite folder (for SEO)
    RewriteRule ^sitemap\.xml$ xsite/sitemap.xml [L]
    RewriteRule ^sitemap_index\.xml$ xsite/sitemap_index.xml [L]

    # Default rewrite to xsite folder
    RewriteCond %{REQUEST_URI} !^/xadmin [NC]
    RewriteCond %{REQUEST_URI} !^/phpmyadmin [NC]
    RewriteCond %{REQUEST_URI} !^/claude\.php$ [NC]
    RewriteRule ^(.*)$ xsite/$1 [L]
</IfModule>

# Single security header and simple caching that's known to work
<IfModule mod_headers.c>
    # Protection against clickjacking
    Header always set X-Frame-Options "SAMEORIGIN"
    
    # Simple cache control for static assets only
    <FilesMatch "\.(jpg|jpeg|png|gif|ico|css|js)$">
        Header set Cache-Control "max-age=2592000, public"
    </FilesMatch>
</IfModule>

# Basic compression (working)
<IfModule mod_deflate.c>
    # Compress text files only
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/javascript
</IfModule>
