# Pump Inquiry Form - Final Verification & Deployment Guide

**Date:** 2025-11-03  
**Status:** Ready for Testing & Deployment

## Overview
The extended pump inquiry form has been successfully implemented with 31 fields across 4 sections, reCAPTCHA v3 integration, comprehensive validation, and responsive design.

## Files Modified

### 1. Frontend (Form HTML)
**File:** `/xsite/mod/pump-inquiry/x-pump-inquiry.php`
- ✅ Complete form with 31 fields across 4 sections
- ✅ Responsive CSS with mobile-first design
- ✅ 8 dropdown arrays with proper options
- ✅ Checkbox groups for pump types
- ✅ File upload input with type/size hints
- ✅ reCAPTCHA API script loading
- ✅ Form framework integration via mxForm class
- ✅ Removed duplicate pageType hidden field

### 2. Backend (Form Submission)
**File:** `/xsite/mod/pump-inquiry/x-pump-inquiry-inc.php`
- ✅ savePumpInquiry() function with complete validation
- ✅ reCAPTCHA v3 token verification with cURL fallback
- ✅ All required field validation
- ✅ Email format validation using filter_var()
- ✅ Indian mobile number validation with regex
- ✅ Pin code (6-digit) validation
- ✅ Numeric field validation
- ✅ File upload handling with mxGetFileName()
- ✅ Multi-select checkbox to comma-separated conversion
- ✅ reCAPTCHA score logging

### 3. Client-Side Validation (JavaScript)
**File:** `/xsite/mod/pump-inquiry/inc/js/x-pump-inquiry.inc.js`
- ✅ Explicit field validation (no loops)
- ✅ Form submission handler with loading indicator
- ✅ reCAPTCHA v3 token generation
- ✅ Fallback if reCAPTCHA API unavailable
- ✅ Console logging for debugging
- ✅ Consent checkbox requirement
- ✅ File size/type validation

### 4. Database Schema
**File:** `/pump_inquiry_alter_table.sql`
- ✅ 23 new columns defined
- ✅ Proper data types (INT, VARCHAR, DECIMAL, TEXT)
- ✅ Indexes for performance
- ✅ Uses IF NOT EXISTS clauses for safety

## Configuration

### reCAPTCHA Keys (v3 - Invisible)
```
Site Key:   6LeVCf0rAAAAAG3JjibEriASu2AwVx8v-6pxZHlZ
Secret Key: 6LeVCf0rAAAAABhzHVTK76BApoP66LDaXdYaUBN-
```

### Form Framework Integration
- Form Action: `savePumpInquiry`
- Form ID: `pumpInquiryForm`
- Hidden Fields Generated by `$MXFRM->closeForm()`:
  - `xAction` = "savePumpInquiry"
  - `modName` = (framework-generated)
  - `pageType` = (framework-generated)
  - `langCode` = (framework-generated)

## Pre-Deployment Checklist

### Database Setup
- [ ] Connect to MySQL/MariaDB database
- [ ] Execute `pump_inquiry_alter_table.sql` script
- [ ] Verify all 23 new columns added to `bombay_pump_inquiry` table
- [ ] Verify indexes created: `idx_status_date`, `idx_email`, `idx_application`
- [ ] Verify upload directory exists: `/uploads/pump-inquiry/`
- [ ] Set upload directory permissions to 755

### Form Testing (localhost)

#### 1. Form Display & Styling
- [ ] Load form on desktop browser (1920px+)
- [ ] Load form on tablet (768px)
- [ ] Load form on mobile (375px)
- [ ] All fields display correctly
- [ ] Responsive grid layout working
- [ ] Typography matches site theme (Manrope + Libre Baskerville)
- [ ] Color scheme matches (#157bba primary)
- [ ] Required field indicators (*) visible
- [ ] reCAPTCHA badge visible in bottom-right corner

#### 2. Section 1: Customer Details
- [ ] Full Name field accepts text
- [ ] Company Name field optional
- [ ] Email field accepts email format
- [ ] Mobile Number field with placeholder
- [ ] Phone Number field optional
- [ ] Address field as textarea
- [ ] City dropdown displays all options (Mumbai, Pune, Ahmedabad, Other)
- [ ] Pin Code field accepts 6 digits only
- [ ] Preferred Contact Time dropdown (Morning, Afternoon, Evening)

#### 3. Section 2: Application Details
- [ ] Application Type dropdown displays all options
- [ ] Purpose of Pump field accepts text
- [ ] Installation Type dropdown displays all options
- [ ] Operating Medium dropdown displays all options
- [ ] Water Source dropdown displays all options
- [ ] Required Head field accepts numeric input
- [ ] Required Discharge field accepts text
- [ ] Pumping Distance field accepts numeric input
- [ ] Height Difference field accepts numeric input
- [ ] Pipe Size field accepts text
- [ ] Power Supply dropdown displays both options (Single Phase, Three Phase)
- [ ] Operating Hours field accepts 0-24
- [ ] Automation Needed dropdown (Yes, No)
- [ ] Existing Pump Model field accepts text
- [ ] File upload field shows drag-drop area with hints

#### 4. Section 3: Product Preferences
- [ ] Preferred Brand dropdown displays 4 options
- [ ] Pump Type checkboxes all display correctly
- [ ] Material Preference dropdown displays 5 options
- [ ] Motor HP/kW field accepts text
- [ ] Quantity Required field accepts positive numbers

#### 5. Section 4: Consent & Submission
- [ ] Consent checkbox displays with proper styling
- [ ] Submit button styled correctly
- [ ] Form note about required fields visible

#### 6. Validation Testing

**Required Field Validation:**
- [ ] Submit form with only Full Name filled → Error for each missing required field
- [ ] Submit form with only Email filled → Error for each missing required field
- [ ] Submit form with City empty → "Please select City" error
- [ ] Submit form with Application Type empty → "Please select Application Type" error

**Field-Level Validation:**
- [ ] Enter invalid email (no @) → Email validation error
- [ ] Enter Indian mobile without 10 digits → Mobile validation error
- [ ] Enter mobile starting with 5 → Mobile validation error
- [ ] Enter pin code with 5 digits → Pin code validation error
- [ ] Enter text in numeric fields → Validation error
- [ ] Enter operating hours > 24 → Validation error
- [ ] Enter negative quantity → Validation error

**File Upload Validation:**
- [ ] Upload file > 5MB → File size validation error
- [ ] Upload .exe or .txt file → File type validation error
- [ ] Upload valid PDF, JPG, PNG → File accepted
- [ ] Submit without file → Form submits (file optional)

**Consent Validation:**
- [ ] Submit form without checking consent → "Please agree to consent" error
- [ ] Check consent → Required validation passes

#### 7. Submission Testing

**Successful Submission:**
- [ ] Fill all required fields with valid data
- [ ] Submit form
- [ ] Loading indicator appears
- [ ] Open Browser Console (F12) → Check for log messages
- [ ] Console should show: "grecaptcha token received"
- [ ] Success message appears on page
- [ ] Page reloads after 3 seconds
- [ ] Form is cleared after reload

**Database Verification:**
- [ ] Check `bombay_pump_inquiry` table for new record
- [ ] Verify all submitted field values in database
- [ ] Verify reCAPTCHA score logged in `gRecaptchaScore` column
- [ ] Verify file uploaded to `/uploads/pump-inquiry/` if applicable

#### 8. reCAPTCHA Testing

**Browser Console Debug:**
- [ ] Open F12 Developer Console
- [ ] Submit form
- [ ] Check logs show: "Form validation started"
- [ ] Check logs show: "grecaptcha is available"
- [ ] Check logs show: "reCAPTCHA token received"
- [ ] Check logs show: "Submitting form with token"

**reCAPTCHA Verification:**
- [ ] Google reCAPTCHA API loads successfully
- [ ] No CORS errors in console
- [ ] Badge appears in bottom-right corner
- [ ] Form submits with token to backend
- [ ] Backend verifies token and logs score
- [ ] Form still submits if reCAPTCHA API fails (graceful fallback)

#### 9. Mobile Experience
- [ ] Form scrolls smoothly on mobile
- [ ] Touch inputs work properly
- [ ] Checkboxes easy to tap (18px minimum)
- [ ] Dropdowns open properly on mobile
- [ ] File upload works on mobile
- [ ] Submit button accessible at bottom
- [ ] Responsive CSS media queries working

#### 10. Cross-Browser Testing
- [ ] Chrome/Chromium
- [ ] Firefox
- [ ] Safari (if available)
- [ ] Edge (Windows)
- [ ] Mobile browsers (Chrome Mobile, Safari Mobile)

## Database Schema Details

### New Columns Added
```
CUSTOMER DETAILS:
- fullName (VARCHAR 100)
- companyName (VARCHAR 100)
- phoneNumber (VARCHAR 20)
- address (TEXT)
- city (VARCHAR 50)
- pinCode (INT 6)
- preferredContactTime (VARCHAR 50)

APPLICATION DETAILS:
- applicationTypeID (INT)
- purposeOfPump (TEXT)
- installationTypeID (INT)
- operatingMediumID (INT)
- waterSourceID (INT)
- requiredHead (DECIMAL 10,2)
- requiredDischarge (VARCHAR 50)
- pumpingDistance (DECIMAL 10,2)
- heightDifference (DECIMAL 10,2)
- pipeSize (VARCHAR 50)
- powerSupplyID (INT)
- operatingHours (INT)
- automationNeededID (INT)
- existingPumpModel (VARCHAR 100)
- uploadedFile (VARCHAR 255)

PRODUCT PREFERENCES:
- preferredBrandID (INT)
- pumpTypesInterested (TEXT - comma-separated)
- materialPreferenceID (INT)
- motorRating (VARCHAR 50)
- quantityRequired (INT)

SECURITY:
- consentGiven (TINYINT)
- gRecaptchaScore (DECIMAL 3,2)
```

### Indexes Created
```
- idx_status_date (status, createdDate)
- idx_email (userEmail)
- idx_application (applicationTypeID)
```

## Deployment Steps

### Step 1: Execute Database Changes
```sql
-- Connect to database and run:
SOURCE /path/to/pump_inquiry_alter_table.sql;

-- Or via CLI:
mysql -u $USER -p $DATABASE < pump_inquiry_alter_table.sql
```

### Step 2: Create Upload Directory
```bash
mkdir -p /home/bombayengg/public_html/uploads/pump-inquiry
chmod 755 /home/bombayengg/public_html/uploads/pump-inquiry
```

### Step 3: Verify File Permissions
```bash
chmod 644 /home/bombayengg/public_html/xsite/mod/pump-inquiry/x-pump-inquiry.php
chmod 644 /home/bombayengg/public_html/xsite/mod/pump-inquiry/x-pump-inquiry-inc.php
chmod 644 /home/bombayengg/public_html/xsite/mod/pump-inquiry/inc/js/x-pump-inquiry.inc.js
```

### Step 4: Test in Staging
- Follow all tests above before going to production

### Step 5: Deploy to Production
- Git commit all changes
- Git push to remote
- Deploy changes to production server

## Troubleshooting Guide

### Issue: "Please select City" error even with city selected

**Solution:**
1. Open Browser Console (F12)
2. Type: `$('select[name="city"]').val()`
3. Press Enter - should show selected city value
4. If empty, form JavaScript not loading properly:
   - Check `/xsite/mod/pump-inquiry/inc/js/x-pump-inquiry.inc.js` is loaded
   - Check for JavaScript errors in Console

### Issue: Form not submitting (no response)

**Solution:**
1. Check Console (F12) for errors
2. Check Network tab - verify POST request to x-pump-inquiry-inc.php
3. Check server error logs: `/var/log/apache2/error.log`
4. Verify `core.inc.php` file path is correct (should be `../../../core/core.inc.php`)

### Issue: reCAPTCHA not verifying

**Solution:**
1. Verify reCAPTCHA keys are correct:
   - Site Key: `6LeVCf0rAAAAAG3JjibEriASu2AwVx8v-6pxZHlZ`
   - Secret Key: `6LeVCf0rAAAAABhzHVTK76BApoP66LDaXdYaUBN-`
2. Check server has internet access for verification
3. Verify console shows "grecaptcha token received"
4. Check backend logs for token verification result

### Issue: File upload fails

**Solution:**
1. Check upload directory exists: `/uploads/pump-inquiry/`
2. Check directory permissions: `ls -la /home/bombayengg/public_html/uploads/pump-inquiry/`
3. Verify file size < 5MB
4. Verify file type is PDF, JPG, or PNG
5. Check `php.ini` for `upload_max_filesize` and `post_max_size`

### Issue: Database schema not updated

**Solution:**
1. Verify ALTER TABLE script executed without errors
2. Check table structure: `DESC bombay_pump_inquiry;`
3. Verify new columns exist
4. Check indexes: `SHOW INDEX FROM bombay_pump_inquiry;`

## Support & Documentation

**Form Location:**
- Frontend: `/xsite/mod/pump-inquiry/x-pump-inquiry.php`
- Backend: `/xsite/mod/pump-inquiry/x-pump-inquiry-inc.php`
- JavaScript: `/xsite/mod/pump-inquiry/inc/js/x-pump-inquiry.inc.js`

**Upload Directory:**
- Path: `/uploads/pump-inquiry/`
- Max Size: 5MB per file

**Database:**
- Table: `bombay_pump_inquiry`
- Primary Key: `pumpInquiryID`
- Status Column: `status` (1=active, 0=inactive)

**Required Fields:**
- fullName, userEmail, userMobile, city
- applicationTypeID, installationTypeID, operatingMediumID, waterSourceID, powerSupplyID
- consentGiven

## Future Enhancements

1. Admin add/edit form (x-pump-inquiry-add-edit.php)
2. Admin list view with search/filter functionality
3. Email notifications on form submission
4. PDF export of inquiries
5. Inquiry status tracking (New, Contacted, Converted)
6. Lead scoring based on requirements
7. Email follow-up automation

---

**Last Updated:** 2025-11-03  
**Status:** Ready for Deployment
